
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>СВУ месенджер</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <style>
       .list-group-item{
           width: -webkit-fill-available;
           position: relative;
           display: block;
           padding: .75rem 1.25rem;
           margin-bottom: -1px;
           text-align: center;
           background-color: #fff;
           border: 1px solid rgba(0, 0, 0, .125);
       }
       a {
        color: #000000;
        text-decoration: none;
        background-color: lavender;
        border-radius: 30px;
        padding: 5px;
        vertical-align: -webkit-baseline-middle;
    }
    .chat-box {
        height: 350px; /* Уменьшаем высоту chat-box */
        overflow-y: scroll;
        border: 1px solid #ddd;
        padding: 10px;
        margin-bottom: 10px;
    }
    .notification {
        background-color: #f8f9fa;
        border: 1px solid #ddd;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        margin-top: 5px; /* Отступ между уведомлениями */
        max-width: 300px; /* Максимальная ширина уведомления */
        word-wrap: break-word; /* Разрешаем перенос слов */
    }
    .notification-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        z-index: 10;
    }

.create_group{
    background-color: blueviolet;
}
</style>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.2/socket.io.js"></script>
<script>    
    function scrollToBottom() {
        var chatBox = document.querySelector('.chat-box');
        chatBox.scrollTop = chatBox.scrollHeight;
    }
    
    $(document).ready(function() {
        var socket = io.connect('http://' + document.domain + ':' + location.port);
        var recipient = '{{ recipient }}';
        var current_user = '{{ current_user }}'
        socket.on('connect', function() {
            socket.emit('join', { 'room': current_user });
        });

        
        let isTabFocused = true;

    // Обработчик события фокуса вкладки
    window.onfocus = function() {
        isTabFocused = true;
    };

    // Обработчик события потери фокуса вкладки
    window.onblur = function() {
        isTabFocused = false;
    };


   socket.on('message', function(data) {
        if(data.recipient == recipient || data.sender == recipient){
            var messageElement = '';
            if (data.is_file) {
                messageElement = `<p><strong>${data.sender}:</strong> <a href="${data.content}" target="_blank">Скачать файл</a> <small>${data.timestamp}</small></p>`;
            } 
            else {
                messageElement = `<p><strong>${data.sender}:</strong> ${data.content} <small>${data.timestamp}</small></p>`;
            }
            $(".chat-box").append(messageElement);
            scrollToBottom();
        }
        else{
            if (data.sender != current_user) {
                var notificationText = data.sender + ' -> ' + data.recipient + ': '+ data.content;
                showNotification(notificationText);
            }
        }
    });

    $('form#message-form').submit(function(event) {
        event.preventDefault();
        var messageContent = $('#message-input').val();
        socket.emit('send_message', {'recipient': recipient, 'content': messageContent, 'is_file': 0});
        $('#message-input').val('');
        return false;
    });

    $('form#file-form').submit(function(event) {
        event.preventDefault();
        var formData = new FormData(this);
        $.ajax({
            url: '/upload',
            type: 'POST',
            data: formData,
            success: function(data) {
                socket.emit('send_message', {'recipient': recipient, 'content': data.url, 'is_file': 1});
            },
            cache: false,
            contentType: false,
            processData: false
        });
        return false;
    });

    function fetchMessages() {
        $.get("/get_messages/{{ recipient }}", function(data) {
            $(".chat-box").empty();
            data.forEach(function(message) {
                var messageElement = '';
                if (message.is_file) {
                    messageElement = `<p><strong>${message.sender}:</strong> <a href="${message.content}" target="_blank">Скачать файл</a> <small>${message.timestamp}</small></p>`;
                } else {
                    messageElement = `<p><strong>${message.sender}:</strong> ${message.content} <small>${message.timestamp}</small></p>`;
                }
                $(".chat-box").append(messageElement);
            });
        });
    }

    fetchMessages();
    scrollToBottom();

    window.onbeforeunload = function() {
        socket.emit('leave', { 'room': current_user });
    };


            // Функция для отображения уведомления
            function showNotification(message) {
                var notification = $('<div>').addClass('notification').text(message);
                $('.notification-container').append(notification);
                if (!isTabFocused){alert("Новое сообщение! "+ message)}
                notification.fadeIn();
                setTimeout(function() {
                    notification.fadeOut(function() {
                        $(this).remove(); // Удаляем уведомление из DOM
                    });
                }, 7000);
            }
        });

    </script>
</head>
<body>
    <h1 style="text-align: center">СВУ мессенджер</h1>
    <h1 style="text-align: center">Добро пожаловать, {{ current_user }}</h1>
    <h1 style="text-align: center">Чат с {{ recipient }}</h1>
    <div class="container">
            {% with messages = get_flashed_messages() %}
          {% if messages %}
            <ul>
              {% for message in messages %}
                <li><h3>{{ message }}</h3></li>
              {% endfor %}
            </ul>
          {% endif %}
        {% endwith %}
        <a href="{{ url_for('logout') }}" class="btn btn-danger">Выйти</a>
        <a href="{{ url_for('index') }}" class="btn btn-primary">На главную</a>
        {% if current_user == "admin" %}
            <a href="{{ url_for('admin_index') }}" class="btn btn-secondary">Панель администратора</a>
            {% endif %}
        <div class="row">
            <div class="col-3">
                <h2>Пользователи</h2>
                <ul class="list-group">
                    {% for user in users %}
                    <li class="list-group-item">
                        <a href="{{ url_for('chat', recipient=user.username) }}">{{ user.username }}</a>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            <div class="col-6">
                <div class="chat-box">
                    <!-- Messages will be loaded here by JavaScript -->
                </div>
                <form id="message-form">
                    <div class="form-group">
                        <input type="text" class="form-control" id="message-input" placeholder="Enter message">
                    </div>
                    <button type="submit" class="btn btn-primary">Отправить</button>
                </form>
                <form id="file-form" method="POST" enctype="multipart/form-data">
                    <input type="file" name="file">
                    <button type="submit" class="btn btn-secondary">Загрузить</button>
                </form>

                <div>
                    <h2>{{ 'Users in group' if isGroup}}</h2>
                {% if is_Creator %}
                 <a href="{{ url_for('group_settings', groupname = recipient) }}" class="btn btn-primary">Настройки группы</a>
                    {% endif %}
                    {% if recipient == 'general' %}
                    <style>
                     .h2,.ol,.li,.p {
                        font-family: Arial, sans-serif;
                        line-height: 1.6;
                        margin: 0;
                    }
                    .h2 {
                        color: #333;
                    }
                    .ol {
                     padding-left: 20px;
                    }

    
                    </style>
                <h2 class='h2'>Правила Общего Чата</h2>

                <ol class='ol'>
                <li class='li'><strong>Уважение и вежливость</strong>
                    <p class='p'>Будьте вежливы и уважительны ко всем участникам чата. Избегайте грубых, оскорбительных и уничижительных высказываний.</p>
                </li>
                <li class='li' ><strong>Тематика и содержание</strong>
                    <p class='p'>Обсуждайте только темы, соответствующие назначению чата. Запрещены обсуждения, касающиеся политики, религии и других спорных тем, способных вызвать конфликты.</p>
                </li>
                <li class='li'><strong>Грамотность и культура речи</strong>
                 <p class='p'>Старайтесь писать грамотно, избегая жаргона и сленга. Не используйте чрезмерное количество смайлов и заглавных букв.</p>
                    </li>
                <li class='li'><strong>Конфиденциальность</strong>
                    <p class='p'>Не разглашайте личную информацию участников чата без их согласия. Соблюдайте конфиденциальность и не распространяйте личные данные.</p>
                </li>
                    {% endif %}

                    <ul class="list-group">
                     {% for user in users_in_group %}
                    <li>
                        {{ user[0] }}
                    </li>
                    {% endfor %}
                </ul>
                </div>
            </div>
                            <div class="col-3">
            <h2>Группы</h2>
                <ul class="list-group">
                    <li class="list-group-item">
                        <a class="create_group" href="{{ url_for('create_group') }}">Создать группу</a>
                    </li>
                    <li class="list-group-item">
                        <a href="{{ url_for('chat', recipient='general') }}">Общий чат</a>
                    </li>
                    {% for group in groups %}
                        <li class="list-group-item">
                            <a href="{{ url_for('chat', recipient=group.groupname) }}">{{ group.groupname }}</a>
                        </li>
                    {% endfor %}
                </ul>
            </div>
        </div>

    </div>
    <div class="notification-container">
    </div>

</body>
</html>

